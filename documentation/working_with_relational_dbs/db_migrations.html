<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/documentation/working_with_relational_dbs/db_migrations.md at 2023-12-07
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20231207" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Ninja &#x2013; Database Migrations</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />
    <script type="text/javascript" src="../../js/apache-maven-fluido-1.7.min.js"></script>
<meta name="description"
                  content="Ninja is a full stack web framework for Java.
                    Rock solid, fast and super productive."/>
            <link rel="icon" type="image/png" href="favicon.png" />

            <link href='//fonts.googleapis.com/css?family=Titillium+Web' rel='stylesheet' type='text/css'/>
            <link href='//fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'/>
            <link href='//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css' rel='stylesheet' type='text/css'/>

            <script type="text/javascript">

                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-38154034-1']);
                _gaq.push(['_trackPageview']);

                (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();

            </script>
  </head>
  <body class="topBarDisabled">
    <a href="https://github.com/ninjaframework/ninja">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
        alt="Fork me on GitHub">
    </a>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="../../.." id="bannerLeft" title="Ninja web framework"><img src="../../ninja_logo.png"  alt="Ninja web framework"/></a></div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2023-12-07</li>
          <li id="projectVersion" class="pull-right">Version: 7.0.1-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">Introduction</li>
    <li><a href="../../introduction.html" title="The problem we solve"><span class="none"></span>The problem we solve</a></li>
    <li><a href="../../high_level_overview.html" title="Ninja - high level overview"><span class="none"></span>Ninja - high level overview</a></li>
    <li><a href="../../team.html" title="The team"><span class="none"></span>The team</a></li>
      <li class="nav-header">Commercial support</li>
    <li><a href="../../commercial_support/philosophy.html" title="Philosophy"><span class="none"></span>Philosophy</a></li>
    <li><a href="../../commercial_support/training.html" title="Training"><span class="none"></span>Training</a></li>
    <li><a href="../../commercial_support/support_plans.html" title="Support plans"><span class="none"></span>Support plans</a></li>
    <li><a href="../../commercial_support/agile_custom_development.html" title="Custom development"><span class="none"></span>Custom development</a></li>
      <li class="nav-header">Documentation</li>
    <li><a href="../../documentation/getting_started/installing_ninja.html" title="Getting Started"><span class="icon-chevron-right"></span>Getting Started</a></li>
    <li><a href="../../documentation/basic_concepts/basic_concepts.html" title="Basic concepts"><span class="icon-chevron-right"></span>Basic concepts</a></li>
    <li><a href="../../documentation/configuration_and_modes.html" title="Configuration and modes"><span class="none"></span>Configuration and modes</a></li>
    <li><a href="../../documentation/html_templating/getting_started.html" title="HTML templating"><span class="icon-chevron-right"></span>HTML templating</a></li>
    <li><a href="../../documentation/working_with_json_jsonp.html" title="Working with JSON / JSONP"><span class="none"></span>Working with JSON / JSONP</a></li>
    <li><a href="../../documentation/working_with_xml.html" title="Working with XML"><span class="none"></span>Working with XML</a></li>
      <li class="nav-header">Advanced topics</li>
    <li><a href="../../documentation/websockets.html" title="Web Sockets"><span class="none"></span>Web Sockets</a></li>
    <li><a href="../../documentation/validation.html" title="Validation"><span class="none"></span>Validation</a></li>
    <li><a href="../../documentation/content_negotiation.html" title="Content negotiation"><span class="none"></span>Content negotiation</a></li>
    <li><a href="../../documentation/uploading_files.html" title="Uploading files"><span class="none"></span>Uploading files</a></li>
    <li><a href="../../documentation/scheduler.html" title="Scheduler"><span class="none"></span>Scheduler</a></li>
    <li><a href="../../documentation/lifecycle.html" title="Lifecycle"><span class="none"></span>Lifecycle</a></li>
    <li><a href="../../documentation/working_with_relational_dbs/jpa.html" title="Working with relational DBs"><span class="icon-chevron-down"></span>Working with relational DBs</a>
    <ul class="nav nav-list">
    <li class="active"><a href="#"><span class="none"></span>DB Migrations</a></li>
    </ul>
</li>
    <li><a href="../../documentation/using_the_cache.html" title="Using the cache"><span class="none"></span>Using the cache</a></li>
    <li><a href="../../documentation/internationalization.html" title="Internationalization"><span class="none"></span>Internationalization</a></li>
    <li><a href="../../documentation/static_assets.html" title="Static assets"><span class="none"></span>Static assets</a></li>
    <li><a href="../../documentation/sending_mail.html" title="Sending mail"><span class="none"></span>Sending mail</a></li>
    <li><a href="../../documentation/logging.html" title="Logging"><span class="none"></span>Logging</a></li>
    <li><a href="../../documentation/custom_routing.html" title="Custom routing"><span class="none"></span>Custom routing</a></li>
    <li><a href="../../documentation/servlet_bridge.html" title="Servlet bridge"><span class="none"></span>Servlet bridge</a></li>
    <li><a href="../../documentation/console.html" title="Console application"><span class="none"></span>Console application</a></li>
    <li><a href="../../documentation/testing_your_application/getting_started.html" title="Testing"><span class="icon-chevron-right"></span>Testing</a></li>
    <li><a href="../../documentation/debugging.html" title="Debugging"><span class="none"></span>Debugging</a></li>
    <li><a href="../../documentation/security/getting_started.html" title="Security"><span class="none"></span>Security</a></li>
    <li><a href="../../documentation/deployment/getting_started.html" title="Deployment"><span class="icon-chevron-right"></span>Deployment</a></li>
    <li><a href="../../documentation/upgrade_guide.html" title="Upgrade guide"><span class="none"></span>Upgrade guide</a></li>
    <li><a href="../../apidocs/index.html" title="API docs (JavaDoc)"><span class="none"></span>API docs (JavaDoc)</a></li>
      <li class="nav-header">Ninja Modules</li>
    <li><a href="../../documentation/modules.html" title="Overview"><span class="none"></span>Overview</a></li>
      <li class="nav-header">Great community</li>
    <li><a href="https://twitter.com/ninjaframework" class="externalLink" title="@ninjaframework"><span class="none"></span>@ninjaframework</a></li>
    <li><a href="https://groups.google.com/d/forum/ninja-framework" class="externalLink" title="Mailing list"><span class="none"></span>Mailing list</a></li>
    <li><a href="https://github.com/ninjaframework/ninja" class="externalLink" title="Source code"><span class="none"></span>Source code</a></li>
    <li><a href="https://github.com/ninjaframework/ninja/issues" class="externalLink" title="Bug tracker"><span class="none"></span>Bug tracker</a></li>
    <li><a href="../../security.html" title="Security issues"><span class="none"></span>Security issues</a></li>
      <li class="nav-header">For developers</li>
    <li><a href="../../developer/changelog.html" title="Changelog"><span class="none"></span>Changelog</a></li>
    <li><a href="../../developer/roadmap.html" title="Roadmap"><span class="none"></span>Roadmap</a></li>
    <li><a href="../../developer/getting_started.html" title="How to contribute"><span class="none"></span>How to contribute</a></li>
</ul>
<form id="search-form" action="https://www.google.com/search" method="get" >
  <input value="https://www.ninjaframework.org" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript">asyncJs( 'https://cse.google.com/brand?form=search-form' )</script>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
    <div id="twitter">
    <a href="https://twitter.com/ninjaframework" class="twitter-follow-button" data-show-count="true" data-align="left" data-size="medium" data-show-screen-name="true" data-lang="en">Follow ninjaframework</a>
    <script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span9" >
<h1>Database Migrations</h1>
<p>When you are using relational databases you need to track and organize schema evolutions.</p>
<p>This becomes increasingly important when many people are collaborating on one code base and also
when you want to consistently upgrade your production database.</p>
<p>To that end Ninja integrates the excellent Flyway migration tool (<a class="externalLink" href="http://flywaydb.org/">http://flywaydb.org/</a>).</p>
<h1>Configuring migrations in Ninja</h1>
<p>Activate migrations by setting the following property:</p>

<div class="source">
<pre class="prettyprint">
ninja.migration.run=true
</pre></div>

<p>Then set the credentials for your database:</p>

<div class="source">
<pre class="prettyprint">
db.connection.url=jdbc:postgresql://localhost:5432/ra
db.connection.username=ra
db.connection.password=
</pre></div>

<h1>Setting up Flyway</h1>
<p>Flyway itself manages database migration scripts in a directory called <code>src/main/java/db/migration</code>. You should use
the following naming convention: <code>V1__.sql</code> is your first script, <code>V2__.sql</code>
is your second script and so on.</p>
<p><code>V1__.sql</code> may look like:</p>

<div class="source">
<pre class="prettyprint">
-- Just a simple table
create table GuestbookEntry (
    id int8 not null,
    email varchar(255),
    text varchar(255),
    primary key (id)
);

--needed for hibernate running on postgresql
create sequence hibernate_sequence;

</pre></div>

<p>A migration script is just plain old SQL. It is really important to stress that Flyway's migration
scripts are NOT database vendor independent.</p>
<p>Therefore it is strongly discouraged to use different databases in test, dev and prod.</p>
<h1>Collaboratively working on migrations</h1>
<p>When two or more developers are working on the same script (let's say V2__.sql) they'll get
conflicts once they are trying to merge their changes.</p>
<p>But this is intentional and allows to fix problems in V2__.sql.
After resolving the issues and running your tests you can be confident
that your production upgrade will also work fine.</p>
<h1>Custom migration scripts location or schema name</h1>
<p>If you want to store your migration scripts in a non-default directory (or directories), set the following optional
property with a comma-separated list of locations.</p>

<div class="source">
<pre class="prettyprint">
ninja.migration.locations=classpath:com.example.migration,filesystem:/sql-migrations
</pre></div>

<p>You can also set a custom schema list using the following property. The first schema in the list will be automatically
set as the default one during the migration.</p>

<div class="source">
<pre class="prettyprint">
ninja.migration.schemas=schema1,schema2,schema3
</pre></div>

<h1>Migrations in test, dev and prod</h1>
<p>In test mode Ninja automatically drops the schema and runs all migrations from scratch. In dev and production
migration scripts are executed automatically when they are detected. Usually this happens when the
first deployed Ninja instance connects with your database. Flyway's migrations are &#x201c;clustersafe&#x201d;. Therefore
nothing will go wrong when you are deploying 20 instances of your application that try to run the evolutions at
the same time.</p>
<h1>Flyway migrations versus Hibernate DDL</h1>
<p>Hibernate - the JPA implementation we are using is already providing a DDL (hbm2ddl) feature
that can manage and create &#x201c;migrations&#x201d; for you.</p>
<p>But Hibernate's hbm2ddl is &#x201c;just&#x201d; a diff tool.
Once your setup gets more complex Hibernate's feature is not enough.
Even the creators of Hibernate strongly discourage the usage in production systems:</p>
<p><b>WARNING: We've seen Hibernate users trying to use SchemaUpdate
to update the schema of a production database automatically.
This can quickly end in disaster and won't be allowed by your DBA.
(From the book Java Persistence with Hibernate).</b></p>
<p>Our recommendation is to enable Hibernate's DDL for your first initial developments.</p>
<p>Enable that by setting the following properties inside your persistence unit (persistence.xml):</p>

<div class="source">
<pre class="prettyprint">
&lt;property name=&quot;hibernate.hbm2ddl.auto&quot; value=&quot;create&quot; /&gt; 
&lt;property name=&quot;hibernate.show_sql&quot; value=&quot;true&quot; /&gt;
&lt;property name=&quot;hibernate.format_sql&quot; value=&quot;true&quot; /&gt;
</pre></div>

<p>Hint: Try using <b>create</b> (always drops data in your db) or <b>update</b> (tries to alter existing tables for
new data) for hibernate.hbm2ddl.auto.</p>
<p>Hibernate will then print out nice SQL statements for the creation of your tables, sequences and so on.</p>
<p>Once your initial prototype is ready copy them to your first migration (eg V1__.sql)
and deactivate Hibernate's DDL feature. From now on use Ninja's migrations and everything is safe.</p>
<h1>More</h1>
<p>Flyway offers a lot more. For instance Java based migrations, that really facilitate refactoring
of blobs. Check out Flyway's excellent site at: <a class="externalLink" href="http://flywaydb.org">http://flywaydb.org</a></p>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2023
<a href="https://www.ninjaframework.org">ninjaframework</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
